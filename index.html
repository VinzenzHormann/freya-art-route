<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beyoƒülu Sanat Rota Planlayƒ±cƒ±sƒ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
   
    <style>
        #beyoglu-sanat-rehberi-app {
            font-family: 'Poppins', sans-serif;
            background-color: #ffffff;
            --color-primary: #12a48e; /* Main Marker Color (Turkuaz) */
            --color-button: #047666; /* Button color */
            --color-hover: #075f52; /* Hover color */
        }
        #beyoglu-sanat-rehberi-app h1 { color: var(--color-primary); font-weight: 700; }
       
        .filter-btn {
            flex-shrink: 0; padding: 0.6rem 1.5rem; font-size: 0.875rem; font-weight: 600;
            color: #fff; background-color: var(--color-button); border: 2px solid var(--color-button);
            border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: all 0.2s ease-in-out;
        }
        .filter-btn:hover { background-color: var(--color-hover); border-color: var(--color-hover); transform: translateY(-1px); }
        .filter-btn.active { background-color: var(--color-primary); border-color: var(--color-primary); box-shadow: 0 6px 10px rgba(18, 164, 142, 0.3); }
       
        .card-link {
            display: inline-flex; align-items: center; padding: 0.375rem 0.875rem; font-size: 0.8125rem;
            font-weight: 600; color: var(--color-button); background-color: rgba(4, 118, 102, 0.1);
            border-radius: 9999px; transition: all 0.2s;
        }
        .card-link:hover { background-color: rgba(4, 118, 102, 0.2); color: var(--color-hover); }
        .icon-color { color: var(--color-primary); }
       
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
       
        .venue-card.selected-for-route { border: 3px solid var(--color-primary); box-shadow: 0 0 15px rgba(18, 164, 142, 0.5); background-color: #f7fcfb; }
       
        .full-screen-container {
            min-height: 100vh;
        }

        @media (min-width: 768px) {
            .map-view-layout #control-panel {
                width: 33.333333%; 
                max-height: 100vh;
                overflow-y: auto;
            }
            .map-view-layout #map-container {
                width: 66.666667%; 
                height: 100vh;
            }
        }
        #map { width: 100%; height: 100%; }
       
    </style>
</head>
<body class="font-sans antialiased text-stone-800">


    <div id="beyoglu-sanat-rehberi-app" class="text-stone-800 full-screen-container flex flex-col">
       
        
        <div id="main-content-wrapper" class="flex flex-col md:flex-row flex-grow w-full">
           
            
            <div id="control-panel" class="w-full p-4 sm:p-6 lg:p-8 bg-white max-w-7xl mx-auto md:max-w-none md:mx-0">
               
                <header class="text-center mb-6 lg:text-left">
                    <h1 class="text-3xl md:text-4xl mb-1 tracking-tight">Beyoƒülu Sanat Rehberi</h1>
                    <p class="text-md text-gray-500 font-normal">Se√ßtiƒüiniz galeriler i√ßin optimize edilmi≈ü y√ºr√ºy√º≈ü rotasƒ± olu≈üturun.</p>
                </header>


                <div class="mb-6 p-4 bg-gray-50 rounded-lg shadow-inner border border-gray-200">
                    <h3 class="text-xl font-semibold mb-3 text-gray-700">Rota Planlayƒ±cƒ±</h3>
                   
                    >
                    <div id="selection-info">
                        <p class="text-sm text-gray-600 mb-4">A≈üaƒüƒ±daki listeden en az iki mekanƒ± se√ßin (kartlara tƒ±klayarak ve etrafƒ±ndaki ye≈üil kenarlƒ±ƒüƒ± kontrol ederek). Rota adƒ±mlarƒ± haritada numara ve isim olarak g√∂r√ºnecektir.</p>
                    </div>


                    
                    <button id="main-action-button" onclick="handleMainAction()" class="filter-btn w-full !text-lg !py-3 !shadow-lg">
                        Optimize Edilmi≈ü Rotayƒ± Hesapla
                    </button>
                   
                    
                    <div id="route-summary" class="mt-4 p-3 bg-white rounded-lg shadow-md border border-gray-100 hidden">
                        <h4 class="font-bold text-base mb-2 text-red-600 flex items-center">
                            <span class="mr-2 text-xl">üìç</span> √ñnerilen Rota Adƒ±mlarƒ±:
                        </h4>
                        <p id="total-distance" class="text-sm text-gray-700"></p>
                        <p id="total-time" class="text-sm text-gray-700 mb-2"></p>
                        <ol id="route-steps" class="list-decimal list-inside text-sm space-y-2"></ol>
                        
                    </div>


                    <div id="alert-box" class="hidden mt-4 p-3 rounded-md border-l-4" role="alert"></div>
                </div>


                
                <div id="selection-content">
                    <nav id="filter-nav" class="flex gap-3 mb-6 overflow-x-auto whitespace-nowrap scrollbar-hide py-2">
                        <button id="filter-all" class="filter-btn active" data-filter="all">T√ºm√º</button>
                        <button id="filter-museum" class="filter-btn" data-filter="museum">M√ºzeler</button>
                        <button id="filter-gallery" class="filter-btn" data-filter="gallery">Galeriler</button>
                    </nav>


                    <main id="venue-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        
                        <div id="loading-indicator" class="col-span-full p-10 text-center text-gray-500 text-lg font-medium">
                            Sanat mekanlarƒ± verileri y√ºkleniyor...
                        </div>
                    </main>
                </div>
            </div>
           
            
            <div id="map-container" class="w-full hidden">
                <div id="map"></div>
            </div>


        </div>
    </div>


    <script>
    
    const API_KEY = YOUR_OWN_API_KEU; 
    const GAS_WEB_APP_URL = YOUR_GAS_WEB_APP_URL;


    let venues = []; let map; let selectedVenues = new Set(); let markers = {};
    let directionsService; let directionsRenderer;
   
    
    let appState = 'selection'; 
    const grid = document.getElementById('venue-grid');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const mainActionButton = document.getElementById('main-action-button');
    const alertBox = document.getElementById('alert-box');
    const routeSummary = document.getElementById('route-summary');
    const selectionContent = document.getElementById('selection-content');
    const selectionInfo = document.getElementById('selection-info');
    const mapContainer = document.getElementById('map-container');
    const controlPanel = document.getElementById('control-panel');
    const mainContentWrapper = document.getElementById('main-content-wrapper');
    const appContainer = document.getElementById('beyoglu-sanat-rehberi-app');


    // -------------------------------------------------------------------
    // I. View State Management
    // -------------------------------------------------------------------


    function switchView(newState) {
        if (appState === newState) return;
        appState = newState;


        if (newState === 'map') {
            appContainer.classList.add('map-view-layout');
            mainContentWrapper.classList.add('md:h-screen');
            controlPanel.classList.remove('max-w-7xl', 'mx-auto');
           
            
            selectionContent.classList.add('hidden');
            selectionInfo.classList.add('hidden');
           
            
            mapContainer.classList.remove('hidden');
            routeSummary.classList.remove('hidden');
           
            
            mainActionButton.textContent = "Rotayƒ± Deƒüi≈ütir";
            mainActionButton.onclick = changeRoute;


            
            if (map) {
                
                google.maps.event.trigger(map, 'resize');
                const stops = Array.from(selectedVenues).map(id => venues.find(v => v.id === id));
                if (stops.length > 0) fitMapToBounds(stops);
            }


        } else if (newState === 'selection') {

           

            appContainer.classList.remove('map-view-layout');
            mainContentWrapper.classList.remove('md:h-screen');
            controlPanel.classList.add('max-w-7xl', 'mx-auto');
           

            selectionContent.classList.remove('hidden');
            selectionInfo.classList.remove('hidden');


 
            mapContainer.classList.add('hidden');
            routeSummary.classList.add('hidden');
            if (directionsRenderer) directionsRenderer.setDirections({ routes: [] });
           

            mainActionButton.textContent = "Optimize Edilmi≈ü Rotayƒ± Hesapla";
            mainActionButton.onclick = handleMainAction;

            venues.forEach(venue => updateMarkerIcon(venue.id, selectedVenues.has(venue.id)));
        }
    }



    function handleMainAction() {
        if (appState === 'selection') {
            calculateRoute();
        } else {
            changeRoute();
        }
    }


    function changeRoute() {
        switchView('selection');
        alertUser('Rota deƒüi≈ütirme moduna ge√ßildi. Yeni mekanlarƒ± se√ßebilir veya mevcutlarƒ± kaldƒ±rabilirsiniz.', 'info');
    }


    // -------------------------------------------------------------------
    // II. Data Fetching and Map Initialization
    // -------------------------------------------------------------------


    async function fetchVenuesFromGAS(attempt = 0) {
        mainActionButton.disabled = true;
        const loadingIndicator = document.getElementById('loading-indicator');
        if (loadingIndicator) loadingIndicator.classList.remove('hidden');


        try {
            const response = await fetch(GAS_WEB_APP_URL);
            if (!response.ok) throw new Error(HTTP hatasƒ±! Durum kodu: ${response.status});
            const data = await response.json();


            if (data && Array.isArray(data)) {
                venues = data.map((v, i) => ({ ...v, id: v.id || i + 1, lat: parseFloat(v.lat), lng: parseFloat(v.lng) }));
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
                alertUser(Ba≈üarƒ±yla ${venues.length} mekan verisi sunucudan y√ºklendi., 'success');
                displayVenues();
                loadGoogleMapsScript();
            } else {
                throw new Error("Sunucudan gelen veri beklenmedik bir formatta.");
            }
        } catch (error) {
            console.error("Veri y√ºkleme hatasƒ±:", error);
            if (attempt < 2) {
                const delay = Math.pow(2, attempt) * 1000;
                alertUser(Veri y√ºkleme hatasƒ±. ${delay / 1000} saniye sonra yeniden denenecek... (Deneme ${attempt + 1}/3), 'error');
                setTimeout(() => fetchVenuesFromGAS(attempt + 1), delay);
            } else {
                if (loadingIndicator) loadingIndicator.textContent = 'HATA: Mekan verileri y√ºklenemedi. L√ºtfen GAS URL\'nizi kontrol edin.';
                alertUser('Mekan verileri y√ºklenemedi. L√ºtfen Google Apps Script URL\'sini ve daƒüƒ±tƒ±mƒ±nƒ± kontrol edin.', 'error');
            }
        } finally {
            mainActionButton.disabled = false;
        }
    }


    function initMap() {
        if (venues.length === 0) return console.error("Harita ba≈ülatƒ±lamadƒ±: Mekan verisi mevcut deƒüil.");
        const initialCenter = { lat: 41.0360, lng: 28.9876 }; 


        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 15, center: initialCenter, streetViewControl: false, mapTypeControl: false,
            styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
        });


        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map, suppressMarkers: true,
            polylineOptions: { strokeColor: var_to_hex('--color-primary'), strokeWeight: 6, strokeOpacity: 0.8 }
        });
       
        venues.forEach(addMarker);
    }
   
    function loadGoogleMapsScript() {
        if (typeof google === 'object' && typeof google.maps === 'object') {
            initMap();
        } else {
            const script = document.createElement('script');

            script.src = https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=geometry&callback=initMap;
            script.async = true;
            document.head.appendChild(script);
        }
    }


    // -------------------------------------------------------------------
    // III. Map, Route, and Marker Logic (Numbered Markers)
    // -------------------------------------------------------------------


    function addMarker(venue) {
  
        const position = new google.maps.LatLng(venue.lat, venue.lng);

        const marker = new google.maps.Marker({ position, map: null, title: venue.name }); 
        
        marker.addListener('click', () => { 

            if (appState === 'selection') {
                toggleVenueSelection(venue.id); 
            }
        });
        
        markers[venue.id] = marker;

        updateMarkerIcon(venue.id, false);
    }
   

    function updateMarkerIcon(venueId, isSelected, stepNumber = null) {
        const marker = markers[venueId]; if (!marker) return;
        const venue = venues.find(v => v.id === venueId); if (!venue) return;
       
        let iconConfig = {}; let labelConfig = null;
        const primaryHex = var_to_hex('--color-primary').replace('#', '');
        const buttonHex = var_to_hex('--color-button').replace('#', '');
       
        if (stepNumber !== null) {

            iconConfig = { 
                path: google.maps.SymbolPath.CIRCLE, 
                scale: 16, 
                fillColor: #${buttonHex}, 
                fillOpacity: 1.0, 
                strokeWeight: 4, 
                strokeColor: '#FFFFFF' 
            };

            labelConfig = { 
                text: stepNumber.toString(), 
                color: '#FFFFFF', 
                fontWeight: '800', 
                fontSize: '16px' 
            };
            marker.setTitle(${stepNumber}. ${venue.name} (Rota Adƒ±mƒ±));
            marker.setMap(map);
        } else {

            const hex = isSelected ? buttonHex : primaryHex;
            iconConfig = { 
                url: https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=|${hex}|FFFFFF, 
                scaledSize: new google.maps.Size(32, 32) 
            };
            marker.setTitle(venue.name + (isSelected ? ' (Se√ßili)' : ''));

            marker.setMap(null); 
        }
        marker.setIcon(iconConfig);
        marker.setLabel(labelConfig);
    }
   
    function var_to_hex(varName) {
        const style = getComputedStyle(document.body);
        const rgb = style.getPropertyValue(varName).trim();
        if (rgb.startsWith('#')) return rgb;
        if (rgb.startsWith('rgb')) {
            const parts = rgb.match(/\d+/g);
            if (parts.length === 3) return "#" + parts.map(x => { const hex = parseInt(x).toString(16); return hex.length === 1 ? '0' + hex : hex; }).join('');
        }
        return '#12a48e';
    }



    async function calculateRoute() {
        if (selectedVenues.size < 2) return alertUser("Rotayƒ± hesaplamak i√ßin l√ºtfen en az iki mekan se√ßin.", 'error');


        mainActionButton.disabled = true;
        mainActionButton.textContent = "Rota Hesaplanƒ±yor...";
        alertBox.classList.add('hidden');
       
        const stops = Array.from(selectedVenues).map(id => venues.find(v => v.id === id));



        let orderedWaypoints = [];
        let unvisitedStops = [...stops];
        let currentStop = unvisitedStops.shift();
        orderedWaypoints.push(currentStop);


        while (unvisitedStops.length > 0) {
            let nearestStop = null;
            let minDistance = Infinity;
            const currentLatLng = new google.maps.LatLng(currentStop.lat, currentStop.lng);


            for (const stop of unvisitedStops) {
                const distance = google.maps.geometry.spherical.computeDistanceBetween(currentLatLng, new google.maps.LatLng(stop.lat, stop.lng));
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestStop = stop;
                }
            }
            if (nearestStop) {
                orderedWaypoints.push(nearestStop);
                currentStop = nearestStop;
                unvisitedStops = unvisitedStops.filter(s => s.id !== nearestStop.id);
            }
        }
       
        const waypoints = orderedWaypoints.slice(1, -1).map(stop => ({ location: new google.maps.LatLng(stop.lat, stop.lng), stopover: true }));


        const request = {
            origin: new google.maps.LatLng(orderedWaypoints[0].lat, orderedWaypoints[0].lng),
            destination: new google.maps.LatLng(orderedWaypoints[orderedWaypoints.length - 1].lat, orderedWaypoints[orderedWaypoints.length - 1].lng),
            waypoints, travelMode: 'WALKING'
        };


        directionsService.route(request, (response, status) => {
            mainActionButton.disabled = false;
           
            if (status === 'OK') {
                directionsRenderer.setDirections(response);
                displayRouteSummary(response, orderedWaypoints);
                switchView('map');
                alertUser('Rotanƒ±z ba≈üarƒ±yla olu≈üturuldu! Haritayƒ± kontrol edin.', 'success');
            } else {

                mainActionButton.textContent = "Optimize Edilmi≈ü Rotayƒ± Hesapla";
                alertUser('Rota hesaplama hatasƒ±: ' + status + '. Koordinatlarƒ± ve API anahtarƒ±nƒ± kontrol edin.', 'error');
                directionsRenderer.setDirections({ routes: [] });
            }
        });
    }
   
    function fitMapToBounds(stops) {
        if (!map) return;
        const bounds = new google.maps.LatLngBounds();
        stops.forEach(stop => bounds.extend(new google.maps.LatLng(stop.lat, stop.lng)));
        map.fitBounds(bounds);
    }


    function displayRouteSummary(response, orderedStops) {
        const leg = response.routes[0].legs;
        let totalDistanceMeters = 0; let totalTimeSeconds = 0;
        const stepsList = document.getElementById('route-steps'); stepsList.innerHTML = '';
       

        leg.forEach((l, index) => {
            totalDistanceMeters += l.distance.value; totalTimeSeconds += l.duration.value;
            const stepNumber = index + 1;
            const startVenue = orderedStops[index];
            const nextVenue = orderedStops[index + 1];
           

            updateMarkerIcon(startVenue.id, true, stepNumber);


            const stepItem = document.createElement('li');

            stepItem.innerHTML = `<span class="font-bold text-base text-gray-800">${startVenue.name}</span> <br> 
                <span class="text-xs text-gray-500">
                    <span class="font-semibold text-gray-700">${l.duration.text}</span> y√ºr√ºy√º≈ü ile ${nextVenue.name}'a (${l.distance.text})
                </span>`;
            stepsList.appendChild(stepItem);
        });
       

        const lastStepNumber = orderedStops.length;
        const lastVenue = orderedStops[orderedStops.length - 1];
        updateMarkerIcon(lastVenue.id, true, lastStepNumber);
       
        const lastItem = document.createElement('li');

        lastItem.innerHTML = <span class="font-bold text-base text-gray-800">${lastVenue.name}</span> (Biti≈ü Noktasƒ±);
        stepsList.appendChild(lastItem);


        document.getElementById('total-distance').textContent = Toplam Y√ºr√ºy√º≈ü Mesafesi: ${(totalDistanceMeters / 1000).toFixed(2)} km;
        document.getElementById('total-time').textContent = Toplam Tahmini Y√ºr√ºy√º≈ü S√ºresi: ${Math.round(totalTimeSeconds / 60)} dakika;

    }


    function toggleVenueSelection(venueId) {

        if (appState === 'map') return;
       
        const cardElement = document.getElementById(venue-card-${venueId});
        const isSelected = selectedVenues.has(venueId);
       
        if (isSelected) {
            selectedVenues.delete(venueId);
            if(cardElement) cardElement.classList.remove('selected-for-route');
            updateMarkerIcon(venueId, false);
        } else {
            selectedVenues.add(venueId);
            if(cardElement) cardElement.classList.add('selected-for-route');
            updateMarkerIcon(venueId, true);
        }
    }


    function createVenueCard(venue) {
        const typeLabel = venue.type === 'museum' ? 'M√ºze' : 'Galeri';
        const typeColor = venue.type === 'museum' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800';
        const isSelected = selectedVenues.has(venue.id);
       
        return `
            <div id="venue-card-${venue.id}" class="venue-card bg-white rounded-xl shadow-lg border border-gray-100 transition-shadow duration-300 hover:shadow-2xl overflow-hidden cursor-pointer ${isSelected ? 'selected-for-route' : ''}"
                data-type="${venue.type}" onclick="toggleVenueSelection(${venue.id})">
                <div class="p-5 relative">
                    <div class="flex justify-between items-start mb-3">
                        <h2 class="text-lg font-semibold text-gray-800 pr-10">${venue.name}</h2>
                        <span class="flex-shrink-0 px-3 py-1 rounded-full text-xs font-medium ${typeColor} shadow-sm">${typeLabel}</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-4">${venue.description}</p>
                    <div class="text-sm text-gray-700 space-y-2 mb-5">
                        <p class="flex items-start"><span class="mr-2 pt-0.5 text-lg icon-color">üè¢</span>${venue.address}</p>
                        <p class="flex items-center"><span class="mr-2 text-lg icon-color">üìû</span>${venue.phone}</p>
                    </div>
                    <div class="flex gap-3 flex-wrap border-t pt-4">
                        <a href="${venue.website}" target="_blank" rel="noopener noreferrer" class="card-link" onclick="event.stopPropagation()">
                            <span class="mr-1.5 text-xs">üåê</span> Website
                        </a>
                    </div>
                </div>
            </div>
        `;
    }


    function displayVenues(filter = 'all') {
        grid.innerHTML = venues.length === 0
            ? '<div id="loading-indicator" class="col-span-full p-10 text-center text-gray-500 text-lg font-medium">Sanat mekanlarƒ± verileri y√ºkleniyor...</div>'
            : venues.filter(v => filter === 'all' || v.type === filter).map(createVenueCard).join('');
    }
   
    function alertUser(message, type) {
        alertBox.textContent = message;
        alertBox.className = 'mt-4 p-3 rounded-md border-l-4';
       
        if (type === 'error') alertBox.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
        else if (type === 'success') alertBox.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
        else alertBox.classList.add('bg-blue-100', 'border-blue-500', 'text-blue-700');


        alertBox.classList.remove('hidden');
        setTimeout(() => alertBox.classList.add('hidden'), 6000);
    }


    document.addEventListener('DOMContentLoaded', () => {
        filterButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                e.currentTarget.classList.add('active');
                displayVenues(e.currentTarget.dataset.filter);
            });
        });
        displayVenues();
        fetchVenuesFromGAS();
        switchView('selection');
    });
    </script>
</body>
</html>