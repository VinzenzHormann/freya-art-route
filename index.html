<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeyoÄŸlu Sanat Rota PlanlayÄ±cÄ±sÄ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap&subset=latin-ext" rel="stylesheet">

   
    <style>
        #beyoglu-sanat-rehberi-app {
            font-family: 'Poppins', sans-serif;
            background-color: #ffffff;
            --color-primary: #12a48e; /* Ana Marka Rengi (Turkuaz) */
            --color-button: #047666; /* Buton Rengi (Koyu YeÅŸil) */
            --color-hover: #075f52; /* Hover Rengi */
        }
        #beyoglu-sanat-rehberi-app h1 { color: var(--color-primary); font-weight: 700; }
       
        .filter-btn {
            flex-shrink: 0; padding: 0.6rem 1.5rem; font-size: 0.875rem; font-weight: 600;
            color: #fff; background-color: var(--color-button); border: 2px solid var(--color-button);
            border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: all 0.2s ease-in-out;
        }
        .filter-btn:hover { background-color: var(--color-hover); border-color: var(--color-hover); transform: translateY(-1px); }
        .filter-btn.active { background-color: var(--color-primary); border-color: var(--color-primary); box-shadow: 0 6px 10px rgba(18, 164, 142, 0.3); }
       
        .card-link {
            display: inline-flex; align-items: center; padding: 0.375rem 0.875rem; font-size: 0.8125rem;
            font-weight: 600; color: var(--color-button); background-color: rgba(4, 118, 102, 0.1);
            border-radius: 9999px; transition: all 0.2s;
        }
        .card-link:hover { background-color: rgba(4, 118, 102, 0.2); color: var(--color-hover); }
        .icon-color { color: var(--color-primary); }
       
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
       
        .venue-card.selected-for-route { border: 3px solid var(--color-primary); box-shadow: 0 0 15px rgba(18, 164, 142, 0.5); background-color: #f7fcfb; }
       
        /* Yeni DÃ¼zen CSS'i */
        .full-screen-container {
            min-height: 100vh;
        }

        /* Harita kapsayÄ±cÄ±larÄ±nÄ±n tam boy olmasÄ± iÃ§in */
        #map { width: 100%; height: 100%; }

        /* MOBÄ°L Ä°Ã‡Ä°N DÃœZELTME: Harita konteynÄ±rÄ±na varsayÄ±lan yÃ¼kseklik veriyoruz */
        #map-container { 
            width: 100%; 
            height: 350px; /* Mobilde harita yÃ¼ksekliÄŸi */
            }
        /* MasaÃ¼stÃ¼nde yan yana (md: breakpoint'ten itibaren) */
        @media (min-width: 768px) {
            .map-view-layout #control-panel {
                width: 33.333333%; /* 1/3 geniÅŸlik */
                max-height: 100vh;
                overflow-y: auto;
            }
            .map-view-layout #map-container {
                width: 66.666667%; /* 2/3 geniÅŸlik */
                height: 100vh;
            }
        }
        /* Harita kapsayÄ±cÄ±larÄ±nÄ±n tam boy olmasÄ± iÃ§in */
        #map { width: 100%; height: 100%; }
       
    </style>
</head>
<body class="font-sans antialiased text-stone-800">


    <div id="beyoglu-sanat-rehberi-app" class="text-stone-800 full-screen-container flex flex-col">
       
        <!-- Ana Ä°Ã§erik KapsayÄ±cÄ±: Selection View'da dikey, Map View'da masaÃ¼stÃ¼nde yatay -->
        <div id="main-content-wrapper" class="flex flex-col md:flex-row flex-grow w-full">
           
            <!-- Kontrol Paneli: Hem SeÃ§im hem de Rota Ã–zeti gÃ¶rÃ¼nÃ¼mÃ¼ iÃ§in kullanÄ±lÄ±r -->
            <div id="control-panel" class="w-full p-4 sm:p-6 lg:p-8 bg-white max-w-7xl mx-auto md:max-w-none md:mx-0">
               
                <header class="text-center mb-6 lg:text-left">
                    <h1 class="text-3xl md:text-4xl mb-1 font-bold">BeyoÄŸlu Sanat Rehberi</h1>
                    <p class="text-md text-gray-500 font-normal">SeÃ§tiÄŸiniz galeriler iÃ§in optimize edilmiÅŸ yÃ¼rÃ¼yÃ¼ÅŸ rotasÄ± oluÅŸturun.</p>
                </header>


                <div class="mb-6 p-4 bg-gray-50 rounded-lg shadow-inner border border-gray-200">
                    <h3 class="text-xl font-semibold mb-3 text-gray-700">Rota PlanlayÄ±cÄ±</h3>
                   
                    <!-- SeÃ§im AÃ§Ä±klamasÄ± (Sadece SeÃ§im GÃ¶rÃ¼nÃ¼mÃ¼nde) -->
                    <div id="selection-info">
                        <p class="text-sm text-gray-600 mb-4">AÅŸaÄŸÄ±daki listeden en az iki mekanÄ± seÃ§in (kartlara tÄ±klayarak ve etrafÄ±ndaki yeÅŸil kenarlÄ±ÄŸÄ± kontrol ederek). Rota adÄ±mlarÄ± haritada numara ve isim olarak gÃ¶rÃ¼necektir.</p>
                    </div>


                    <!-- Ana Eylem Butonu: Duruma gÃ¶re metin ve iÅŸlev deÄŸiÅŸir -->
                    <button id="main-action-button" onclick="handleMainAction()" class="filter-btn w-full !text-lg !py-3 !shadow-lg">
                        Optimize EdilmiÅŸ RotayÄ± Hesapla
                    </button>
                   
                    <!-- Rota Ã–zeti (Sadece Harita GÃ¶rÃ¼nÃ¼mÃ¼nde) -->
                    <div id="route-summary" class="mt-4 p-3 bg-white rounded-lg shadow-md border border-gray-100 hidden">
                        <h4 class="font-bold text-base mb-2 text-red-600 flex items-center">
                            <span class="mr-2 text-xl">ğŸ“</span> Ã–nerilen Rota AdÄ±mlarÄ±:
                        </h4>
                        <p id="total-distance" class="text-sm text-gray-700"></p>
                        <p id="total-time" class="text-sm text-gray-700 mb-2"></p>
                        <ol id="route-steps" class="list-decimal list-inside text-sm space-y-2"></ol>
                        <!-- RotayÄ± Temizle butonu artÄ±k "RotayÄ± DeÄŸiÅŸtir" butonu iÃ§inde hallediliyor -->
                    </div>


                    <div id="alert-box" class="hidden mt-4 p-3 rounded-md border-l-4" role="alert"></div>
                </div>


                <!-- Filtreler ve Mekan KartlarÄ± (Sadece SeÃ§im GÃ¶rÃ¼nÃ¼mÃ¼nde) -->
                <div id="selection-content">
                    <nav id="filter-nav" class="flex gap-3 mb-6 overflow-x-auto whitespace-nowrap scrollbar-hide py-2">
                        <button id="filter-all" class="filter-btn active" data-filter="all">TÃ¼mÃ¼</button>
                        <button id="filter-museum" class="filter-btn" data-filter="museum">MÃ¼zeler</button>
                        <button id="filter-gallery" class="filter-btn" data-filter="gallery">Galeriler</button>
                    </nav>


                    <main id="venue-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- Mekan kartlarÄ± buraya JavaScript ile dinamik olarak yÃ¼klenecek -->
                        <div id="loading-indicator" class="col-span-full p-10 text-center text-gray-500 text-lg font-medium">
                            Sanat mekanlarÄ± verileri yÃ¼kleniyor, bu birkaÃ§ saniye sÃ¼rebilir...
                        </div>
                    </main>
                </div>
            </div>
           
            <!-- Harita KapsayÄ±cÄ± (BaÅŸlangÄ±Ã§ta gizli, Map View'da gÃ¶rÃ¼nÃ¼r) -->
            <div id="map-container" class="w-full hidden">
                <div id="map"></div>
            </div>


        </div>
    </div>


<script>
function getTodayKey() {
    const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
    const dayIndex = new Date().getDay(); 
    console.log("Current Day Index:", dayIndex); // Should be 3 for Wednesday
    return days[dayIndex];
}

    const API_KEY = "AIzaSyAaRDnZ5crli-C2m66Nj0xD8rKfEPSg2o0"; 
    const API_URL = 'https://beyoglu-api-666539972908.europe-west3.run.app/venues';

    let venues = [
    { "id": 1, "name": "Pera MÃ¼zesi", "type": "museum", "description": "Suna ve Ä°nan KÄ±raÃ§ VakfÄ±'na ait Ã¶zel bir mÃ¼ze.", "address": "MeÅŸrutiyet Caddesi No: 65", "phone": "(0212) 334 99 00", "website": "https://www.peramuzesi.org.tr/", "lat": 41.0318522, "lng": 28.97504976, "mon": 0, "tue": 1, "wed": 1, "thu": 1, "fri": 1, "sat": 1, "sun": 1, "price": 300, "info_website": "https://www.peramuzesi.org.tr/ziyaret" },
    { "id": 2, "name": "Ä°stanbul Modern", "type": "museum", "description": "TÃ¼rkiye'nin modern ve Ã§aÄŸdaÅŸ sanat alanÄ±ndaki ilk Ã¶zel mÃ¼zesi.", "address": "Tophane Ä°skele Cd. No:1/1", "phone": "(0212) 334 73 00", "website": "https://www.istanbulmodern.org/", "lat": 41.02635248, "lng": 28.98300056, "mon": 0, "tue": 1, "wed": 1, "thu": 1, "fri": 1, "sat": 1, "sun": 1, "price": 550, "info_website": "https://www.istanbulmodern.org/ziyaret/muze" },
    { "id": 3, "name": "SALT BeyoÄŸlu", "type": "gallery", "description": "Ã‡aÄŸdaÅŸ sanat, mimarlÄ±k ve tasarÄ±m Ã¼zerine sergiler sunan bir kÃ¼ltÃ¼r kurumu.", "address": "Ä°stiklal Caddesi No: 136", "phone": "(0212) 377 42 00", "website": "https://saltonline.org/", "lat": 41.0320979, "lng": 28.97616144, "mon": 0, "tue": 1, "wed": 1, "thu": 1, "fri": 1, "sat": 1, "sun": 0, "price": 0, "info_website": "https://saltonline.org/tr/41" },
    { "id": 4, "name": "SALT Galata", "type": "gallery", "description": "Ã‡aÄŸdaÅŸ sanat, mimarlÄ±k ve tasarÄ±m Ã¼zerine sergiler sunan bir kÃ¼ltÃ¼r kurumu.", "address": "Bankalar Caddesi 11, KarakÃ¶y", "phone": "(0212) 334 22 00", "website": "https://saltonline.org/", "lat": 41.02393677, "lng": 28.97349467, "mon": 0, "tue": 1, "wed": 1, "thu": 1, "fri": 1, "sat": 1, "sun": 0, "price": 0, "info_website": "https://saltonline.org/tr/42" },
    { "id": 5, "name": "ARTER", "type": "museum", "description": "Vehbi KoÃ§ VakfÄ±'na ait bir Ã§aÄŸdaÅŸ sanat mÃ¼zesi.", "address": "Irmak Caddesi No: 13, Dolapdere", "phone": "(0212) 708 58 00", "website": "https://www.arter.org.tr/", "lat": 41.04069689, "lng": 28.97869848, "mon": 0, "tue": 1, "wed": 1, "thu": 1, "fri": 1, "sat": 1, "sun": 1, "price": 450, "info_website": "https://www.arter.org.tr/saatler-bilet-bilgileri" },
    { "id": 6, "name": "Masumiyet MÃ¼zesi", "type": "museum", "description": "Orhan Pamuk'un aynÄ± adlÄ± romanÄ±ndan yola Ã§Ä±karak kurduÄŸu mÃ¼ze.", "address": "Ã‡ukurcuma Cd., DalgÄ±Ã§ Sk. No:2", "phone": "(0212) 252 97 38", "website": "https://www.masumiyetmuzesi.org/", "lat": 41.03093711, "lng": 28.97978146, "mon": 0, "tue": 1, "wed": 1, "thu": 1, "fri": 1, "sat": 1, "sun": 1, "price": 375, "info_website": "https://www.masumiyetmuzesi.org/zi-yaret-g%C3%BCn-ve-saatleri" },
    { "id": 7, "name": "Galeri Zilberman", "type": "gallery", "description": "MÄ±sÄ±r ApartmanÄ±'nda yer alan Ã¶nde gelen Ã§aÄŸdaÅŸ sanat galerilerinden biri.", "address": "Ä°stiklal Cd. MÄ±sÄ±r Apt. No:163 Kat:3", "phone": "(0212) 251 12 14", "website": "https://www.zilbermangallery.com/", "lat": 41.03259605, "lng": 28.97648069, "mon": 0, "tue": 1, "wed": 1, "thu": 1, "fri": 1, "sat": 1, "sun": 0, "price": 0, "info_website": "https://www.zilbermangallery.com/contact.html" },
    { "id": 8, "name": "Galeri Nev Ä°stanbul", "type": "gallery", "description": "TÃ¼rkiye modern ve Ã§aÄŸdaÅŸ sanatÄ±nÄ±n Ã¶nemli temsilcilerini sergileyen kÃ¶klÃ¼ bir galeri.", "address": "Ä°stiklal Cd. MÄ±sÄ±r Apt. No:163 Kat:4", "phone": "(0212) 252 11 85", "website": "https://www.galerinevistanbul.com/tr/", "lat": 41.03269349, "lng": 28.97658504, "mon": 0, "tue": 1, "wed": 1, "thu": 1, "fri": 1, "sat": 1, "sun": 0, "price": 0, "info_website": "https://www.galerinevistanbul.com/tr/contact/" },
    { "id": 9, "name": "Mixer", "type": "gallery", "description": "KarakÃ¶y'de yer alan, genÃ§ ve yÃ¼kselen sanatÃ§Ä±lara odaklanan dinamik bir mekan.", "address": "Mumhane Cd. No:46-50, KarakÃ¶y", "phone": "(0212) 243 54 43", "website": "https://mixerarts.com/", "lat": 41.02570761, "lng": 28.98027143, "mon": 0, "tue": 0, "wed": 0, "thu": 0, "fri": 0, "sat": 0, "sun": 0, "price": 0, "info_website": "https://mixerarts.com/" },
    { "id": 10, "name": "Anna Laudel Gallery", "type": "gallery", "description": "Tarihi bir binada yer alan, yerel ve uluslararasÄ± sanatÃ§Ä±larÄ±n Ã§alÄ±ÅŸmalarÄ±nÄ± sergileyen galeri.", "address": "Banka Sk. No: 10, KarakÃ¶y", "phone": "(0212) 243 32 57", "website": "https://annalaudel.gallery/", "lat": 41.03375577, "lng": 28.98702359, "mon": 0, "tue": 1, "wed": 1, "thu": 1, "fri": 1, "sat": 1, "sun": 1, "price": 0, "info_website": "https://annalaudel.gallery/istanbul/" },
    { "id": 11, "name": "MeÅŸher", "type": "gallery", "description": "Ä°stiklal Caddesi Ã¼zerinde yer alan, geniÅŸ kapsamlÄ± tematik sergilere ev sahipliÄŸi yapan bir sergi mekanÄ±.", "address": "Ä°stiklal Caddesi No: 211", "phone": "(0212) 708 58 01", "website": "https://www.mesher.org/", "lat": 41.03045722, "lng": 28.9759651, "mon": 0, "tue": 1, "wed": 1, "thu": 1, "fri": 1, "sat": 1, "sun": 1, "price": 0, "info_website": "https://www.mesher.org/ziyaret" },
    { "id": 12, "name": "Akbank Sanat", "type": "gallery", "description": "Sergiler, konserler, atÃ¶lye Ã§alÄ±ÅŸmalarÄ± ve sÃ¶yleÅŸiler dÃ¼zenleyen Ã§ok yÃ¶nlÃ¼ bir merkez.", "address": "Ä°stiklal Caddesi No: 8", "phone": "(0212) 252 35 00", "website": "https://www.akbanksanat.com/", "lat": 41.03590822, "lng": 28.98311103, "mon": 0, "tue": 0, "wed": 0, "thu": 0, "fri": 0, "sat": 0, "sun": 0, "price": 0, "info_website": "https://www.akbanksanat.com/" },
    { "id": 13, "name": "YapÄ± Kredi KÃ¼ltÃ¼r Sanat", "type": "gallery", "description": "Galatasaray MeydanÄ±'nda, kÃ¼tÃ¼phane ve kitabevi barÄ±ndÄ±ran Ã¶nemli bir kÃ¼ltÃ¼r merkezi.", "address": "Ä°stiklal Caddesi No: 161", "phone": "(0212) 252 47 00", "website": "https://www.ykykultur.com.tr/", "lat": 41.03322624, "lng": 28.97684141, "mon": 1, "tue": 1, "wed": 1, "thu": 1, "fri": 1, "sat": 1, "sun": 1, "price": 0, "info_website": "https://sanat.ykykultur.com.tr/ziyaret" },
    { "id": 14, "name": "TÃ¼rkiye Ä°ÅŸ BankasÄ± Resim Heykel MÃ¼zesi", "type": "museum", "description": "TÃ¼rkiye Ä°ÅŸ BankasÄ± Sanat Eserleri Koleksiyonuâ€™na ev sahipliÄŸi yapÄ±yor.", "address": "AsmalÄ± Mescit Mh. Ä°stiklal Caddesi. No: 144", "phone": "(0212) 987 37 37", "website": "https://issanat.com.tr/resim-heykel-muzesi/", "lat": 41.03146294, "lng": 28.97599124, "mon": 0, "tue": 1, "wed": 1, "thu": 1, "fri": 1, "sat": 1, "sun": 1, "price": 100, "info_website": "https://issanat.com.tr/resim-heykel-muzesi/" }
];
    let map; 
    let selectedVenues = new Set(); 
    let markers = {};
    let directionsService; 
    let directionsRenderer;
    let appState = 'selection';

    // DOM Elements
    const grid = document.getElementById('venue-grid');
    const mainActionButton = document.getElementById('main-action-button');
    const alertBox = document.getElementById('alert-box');
    const routeSummary = document.getElementById('route-summary');
    const selectionContent = document.getElementById('selection-content');
    const mapContainer = document.getElementById('map-container');
    const appContainer = document.getElementById('beyoglu-sanat-rehberi-app');

    // --- DATA HANDLING ---
    function escapeHTML(str) {
        if (!str) return "";
        const p = document.createElement("p");
        p.textContent = str;
        return p.innerHTML;
    }

async function updateDataFromCloud() {
    try {
        const response = await fetch(API_URL);
        const data = await response.json();
        
        if (data && Array.isArray(data)) {
            venues = data.map((v) => {
                const clean = {};
                // Normalize keys once during import
                Object.keys(v).forEach(k => clean[k.toLowerCase()] = v[k]);

                return { 
                    ...clean, 
                    id: parseInt(clean.id),
                    lat: parseFloat(clean.lat), 
                    lng: parseFloat(clean.lng),
                    // Keep these to ensure the 'isOpen' logic always has a number to check
                    mon: parseInt(clean.mon || 0),
                    tue: parseInt(clean.tue || 0),
                    wed: parseInt(clean.wed || 0),
                    thu: parseInt(clean.thu || 0),
                    fri: parseInt(clean.fri || 0),
                    sat: parseInt(clean.sat || 0),
                    sun: parseInt(clean.sun || 0)
                };
            });
            displayVenues();
            Object.values(markers).forEach(m => m.setMap(null));
            venues.forEach(addMarker);
        }
    } catch (e) {
        // Only log actual errors
        console.error("Sync failed:", e);
    }
}

    // --- VIEW LOGIC ---
    function switchView(newState) {
        appState = newState;
        if (newState === 'map') {
            appContainer.classList.add('map-view-layout');
            selectionContent.classList.add('hidden');
            mapContainer.classList.remove('hidden');
            routeSummary.classList.remove('hidden');
            mainActionButton.textContent = "RotayÄ± DeÄŸiÅŸtir";
            
            // Trigger a resize so Google Maps calculates its container size correctly
            setTimeout(() => {
                google.maps.event.trigger(map, 'resize');
            }, 100);
        } else {
            appContainer.classList.remove('map-view-layout');
            selectionContent.classList.remove('hidden');
            mapContainer.classList.add('hidden');
            routeSummary.classList.add('hidden');
            mainActionButton.textContent = "Optimize EdilmiÅŸ RotayÄ± Hesapla";
            
            // Clear route and reset markers to selection style
            if (directionsRenderer) directionsRenderer.setDirections({ routes: [] });
            venues.forEach(v => updateMarkerIcon(v.id, selectedVenues.has(v.id)));
        }
    }

    function handleMainAction() {
        if (appState === 'selection') calculateRoute();
        else switchView('selection');
    }

    // --- MAP & MARKERS ---
    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 14, 
            center: { lat: 41.0360, lng: 28.9876 },
            streetViewControl: false, 
            mapTypeControl: false,
            styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map, 
            suppressMarkers: true, // This is key to prevent duplicate markers
            polylineOptions: { strokeColor: '#12a48e', strokeWeight: 6 }
        });
updateDataFromCloud();
    }

    function addMarker(venue) {
        const marker = new google.maps.Marker({
            position: { lat: venue.lat, lng: venue.lng },
            map: null,
            title: venue.name
        });
        marker.addListener('click', () => {
            if (appState === 'selection') toggleVenueSelection(venue.id);
        });
        markers[venue.id] = marker;
        updateMarkerIcon(venue.id, false);
    }

    function updateMarkerIcon(venueId, isSelected, stepNumber = null) {
        const marker = markers[venueId];
        if (!marker) return;

        if (stepNumber !== null) {
            // ROUTE MODE: Numbered circles
            marker.setIcon({
                path: google.maps.SymbolPath.CIRCLE,
                scale: 14,
                fillColor: "#047666",
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: "#FFFFFF"
            });
            marker.setLabel({
                text: stepNumber.toString(),
                color: "#FFFFFF",
                fontSize: "12px",
                fontWeight: "bold"
            });
            marker.setMap(map); // Ensure it is visible on map
        } else {
            // SELECTION MODE: Standard pins
            const color = isSelected ? "047666" : "12a48e";
            marker.setIcon({
                url: `https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=|${color}|FFFFFF`,
                scaledSize: new google.maps.Size(30, 30)
            });
            marker.setLabel(null);
            marker.setMap(null); // Hide in selection view until calculation
        }
    }

    // --- ROUTE CALCULATION ---
    async function calculateRoute() {
        if (selectedVenues.size < 2) return alertUser("En az iki mekan seÃ§in.", 'error');
        
        mainActionButton.disabled = true;
        mainActionButton.textContent = "HesaplanÄ±yor...";

        const stops = Array.from(selectedVenues).map(id => venues.find(v => v.id === id));
        
        // Basic TSP sort (nearest neighbor)
        let ordered = [stops[0]];
        let unvisited = stops.slice(1);
        while(unvisited.length > 0) {
            let last = ordered[ordered.length-1];
            unvisited.sort((a,b) => 
                google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(last.lat, last.lng), new google.maps.LatLng(a.lat, a.lng)) -
                google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(last.lat, last.lng), new google.maps.LatLng(b.lat, b.lng))
            );
            ordered.push(unvisited.shift());
        }

        const request = {
            origin: { lat: ordered[0].lat, lng: ordered[0].lng },
            destination: { lat: ordered[ordered.length-1].lat, lng: ordered[ordered.length-1].lng },
            waypoints: ordered.slice(1, -1).map(s => ({ location: { lat: s.lat, lng: s.lng }, stopover: true })),
            travelMode: 'WALKING'
        };

        directionsService.route(request, (response, status) => {
            mainActionButton.disabled = false;
            if (status === 'OK') {
                // 1. Hide all existing markers first
                Object.values(markers).forEach(m => m.setMap(null));
                
                // 2. Draw the line
                directionsRenderer.setDirections(response);
                
                // 3. Show the UI
                switchView('map');
                
                // 4. Place the numbered markers
                displayRouteSummary(response, ordered);
            } else {
                alertUser('Rota bulunamadÄ±: ' + status, 'error');
            }
        });
    }

    function displayRouteSummary(response, orderedStops) {
        const legs = response.routes[0].legs;
        const stepsList = document.getElementById('route-steps'); 
        stepsList.innerHTML = '';

        orderedStops.forEach((stop, i) => {
            updateMarkerIcon(stop.id, true, i + 1);
            
            const li = document.createElement('li');
            li.className = "flex items-start gap-3 p-2 border-b border-gray-50";
            let info = i === 0 ? "BaÅŸlangÄ±Ã§" : `${legs[i-1].duration.text} (${legs[i-1].distance.text})`;
            
            li.innerHTML = `
                <span class="bg-[#047666] text-white rounded-full w-5 h-5 flex items-center justify-center flex-shrink-0 text-[10px] font-bold">${i + 1}</span>
                <div>
                    <p class="font-bold text-sm">${stop.name}</p>
                    <p class="text-[10px] text-gray-400 uppercase">${info}</p>
                </div>
            `;
            stepsList.appendChild(li);
        });
    }

    // --- UI INTERACTION ---
    function toggleVenueSelection(venueId) {
        const card = document.getElementById(`venue-card-${venueId}`);
        if (selectedVenues.has(venueId)) {
            selectedVenues.delete(venueId);
            card.classList.replace('border-[#12a48e]', 'border-transparent');
            card.classList.remove('bg-emerald-50');
        } else {
            selectedVenues.add(venueId);
            card.classList.replace('border-transparent', 'border-[#12a48e]');
            card.classList.add('bg-emerald-50');
        }
    }

    function createVenueCard(venue) {
        const today = getTodayKey();
        const isOpen = venue[today] === 1;         
        const isSelected = selectedVenues.has(venue.id);
        const statusBadge = isOpen ? 'ğŸŸ¢ AÃ§Ä±k' : 'âšª KapalÄ±';
        
return `
            <div id="venue-card-${venue.id}" 
                class="venue-card bg-white rounded-xl shadow-md border-2 p-4 transition-all flex flex-col ${isOpen ? 'cursor-pointer' : 'opacity-50 pointer-events-none'} ${isSelected ? 'border-[#12a48e] bg-emerald-50' : 'border-transparent'}" 
                onclick="toggleVenueSelection(${venue.id})">
                
                <div class="flex justify-between items-start mb-1">
                    <h2 class="text-xl font-bold leading-tight">${escapeHTML(venue.name)}</h2>
                    <span class="text-[10px] font-bold ${isOpen ? 'text-green-600' : 'text-gray-400'}">${statusBadge}</span>
                </div>
                
                <p class="text-gray-500 text-[14px] mb-3 line-clamp-2">${escapeHTML(venue.description)}</p>

                <div class="space-y-1 mb-4 text-[12px] text-gray-600 border-t border-gray-50 pt-2">
                    <div class="flex items-start gap-1">
                        <span class="flex-shrink-0">ğŸ“</span>
                        <span>${escapeHTML(venue.address)}</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="flex-shrink-0">ğŸ“</span>
                        <span>${escapeHTML(venue.phone)}</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="flex-shrink-0">ğŸŒ</span>
                        <a href="${escapeHTML(venue.website)}" target="_blank" rel="nofollow noopener noreferrer" class="hover:underline text-blue-600 truncate" onclick="event.stopPropagation()">Websitesini Ziyaret Et </a>
                    </div>
                </div>

                <div class="flex justify-between items-center pt-2 border-t border-gray-100 mt-auto">
                    <span class="text-[9px] uppercase font-bold text-gray-400">${venue.type}</span>                    
                    <a href="${escapeHTML(venue.info_website)}" target="_blank" rel="nofollow noopener noreferrer" class="hover:underline text-s font-bold text-emerald-700" onclick="event.stopPropagation()">${venue.price > 0 ? venue.price + ' TL' : 'Ãœcretsiz'}</a>
                </div>
            </div>
        `;
    }

    function displayVenues(filter = 'all') {
        grid.innerHTML = venues
            .filter(v => filter === 'all' || v.type === filter)
            .map(createVenueCard).join('');
    }

    function alertUser(msg, type) {
        alertBox.textContent = msg;
        alertBox.className = `mt-4 p-3 rounded border-l-4 ${type === 'error' ? 'bg-red-100 border-red-500 text-red-700' : 'bg-blue-100 border-blue-500 text-blue-700'}`;
        alertBox.classList.remove('hidden');
        setTimeout(() => alertBox.classList.add('hidden'), 3000);
    }

    function loadGoogleMapsScript() {
        const script = document.createElement('script');
        // Added loading=async and v=weekly/beta
        script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=geometry&callback=initMap&loading=async`;
        script.async = true;
        document.head.appendChild(script);
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadGoogleMapsScript();
        //updateDataFromCloud();
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                displayVenues(e.currentTarget.dataset.filter);
            });
        });
    });
</script>
</body>
</html>